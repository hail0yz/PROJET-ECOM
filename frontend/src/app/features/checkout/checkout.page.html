<app-navbar></app-navbar>
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Checkout</h1>
        <p class="text-gray-600 mt-2">Complete your order</p>
    </div>

    @if(!cart() || (cart()?.items || []).length === 0) {
    <div class="bg-white rounded-lg shadow p-12 text-center">
        <p class="text-gray-600 mb-4">Your cart is empty</p>
        <a routerLink="/products" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
            Browse Products
        </a>
    </div>
    } @else {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Order Form -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Delivery Address</h2>
                <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
                    <div formGroupName="address" class="space-y-4">
                        <div>
                            <label for="street" class="block text-sm font-medium text-gray-700 mb-1">Street
                                Address</label>
                            <input type="text" id="street" formControlName="street"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            @if(checkoutForm.get('address.street')?.hasError('required') &&
                            checkoutForm.get('address.street')?.touched) {
                            <p class="mt-1 text-sm text-red-600">Street address is required</p>
                            }
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                                <input type="text" id="city" formControlName="city"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                @if(checkoutForm.get('address.city')?.hasError('required') &&
                                checkoutForm.get('address.city')?.touched) {
                                <p class="mt-1 text-sm text-red-600">City is required</p>
                                }
                            </div>
                            <div>
                                <label for="postalCode" class="block text-sm font-medium text-gray-700 mb-1">Postal
                                    Code</label>
                                <input type="text" id="postalCode" formControlName="postalCode"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                @if(checkoutForm.get('address.postalCode')?.hasError('required') &&
                                checkoutForm.get('address.postalCode')?.touched) {
                                <p class="mt-1 text-sm text-red-600">Postal code is required</p>
                                }
                            </div>
                        </div>

                        <div>
                            <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country</label>
                            <input type="text" id="country" formControlName="country"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            @if(checkoutForm.get('address.country')?.hasError('required') &&
                            checkoutForm.get('address.country')?.touched) {
                            <p class="mt-1 text-sm text-red-600">Country is required</p>
                            }
                        </div>
                    </div>

                    <div formGroupName="paymentDetails" class="mt-6">
                        <h2 class="text-xl font-semibold mb-4">Payment Method</h2>
                        <select id="paymentMethod" formControlName="paymentMethod"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="CREDIT_CARD">Credit Card</option>
                            <option value="DEBIT_CARD">Debit Card</option>
                            <option value="PAYPAL">PayPal</option>
                            <option value="STRIPE">Stripe</option>
                            <option value="VISA">VISA</option>
                            <option value="MASTERCARD">Mastercard</option>
                        </select>
                    </div>

                    <!-- Stripe Card Element placeholder - shown when backend returns client secret -->
                    <div *ngIf="awaitingPayment()" class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Card Details</label>
                        <div id="card-element" class="p-3 border border-gray-300 rounded-md bg-white"></div>
                        <p class="text-xs text-gray-500 mt-2">Your card is processed securely via Stripe.</p>
                    </div>

                    @if(error()) {
                    <div class="mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded text-sm">
                        {{ error() }}
                    </div>
                    }

                    <button *ngIf="!awaitingPayment()" type="submit" [disabled]="loading() || !checkoutForm.valid"
                        class="mt-6 w-full cursor-pointer inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] bg-blue-600 text-white shadow-xs hover:bg-blue-700 h-9 px-4 py-5">
                        @if(loading()) {
                        <span class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span>Placing Order...</span>
                        </span>
                        } @else {
                        <span>Place Order</span>
                        }
                    </button>

                    <!-- Pay button shown when card details are awaited -->
                    <button *ngIf="awaitingPayment()" type="button" (click)="confirmPayment()" [disabled]="loading()"
                        class="mt-6 w-full px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                        @if(loading()) {
                        <span class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            <span>Processing Payment...</span>
                        </span>
                        } @else {
                        <span>Pay Now</span>
                        }
                    </button>
                </form>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
                <div class="space-y-3 mb-4">
                    @for(item of cart()?.items || []; track item.book.id) {
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">{{ item.book.title }}</p>
                            <p class="text-xs text-gray-500">Quantity: {{ item.quantity }}</p>
                        </div>
                        <p class="text-sm font-medium text-gray-900">
                            {{ (item.book.price * item.quantity) | currency:'USD':'symbol':'1.2-2' }}
                        </p>
                    </div>
                    }
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Subtotal</span>
                        <span class="text-sm font-medium text-gray-900">{{ getTotal() | currency:'USD':'symbol':'1.2-2'
                            }}</span>
                    </div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-gray-600">Shipping</span>
                        <span class="text-sm font-medium text-gray-900">Free</span>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                        <span class="text-lg font-semibold text-gray-900">Total</span>
                        <span class="text-lg font-semibold text-gray-900">{{ getTotal() |
                            currency:'EUR':'symbol':'1.2-2' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>
<app-footer></app-footer>